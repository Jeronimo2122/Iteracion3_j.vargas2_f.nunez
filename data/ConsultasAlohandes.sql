--REQUERIMIENTOS DE CONSULTA--

--RFC1--
SELECT operador.id, OPERADOR.NOMBRE AS OPERADOR,SUM(PRECIO) AS DINERO_RECIBIDO_CORRIDO
FROM RESERVA, OPERADOR, ALOJAMIENTO_OPERADOR
WHERE ALOJAMIENTO_OPERADOR.ID_OPERADOR = OPERADOR.ID AND RESERVA.ID_ALOJAMIENTO = ALOJAMIENTO_OPERADOR.ID_ALOJA
GROUP BY operador.id, OPERADOR.NOMBRE
;
SELECT operador.id, OPERADOR.NOMBRE AS OPERADOR,SUM(PRECIO) AS DINERO_RECIBIDO_AÑO_ACTUAL
FROM RESERVA, OPERADOR, ALOJAMIENTO_OPERADOR
WHERE ALOJAMIENTO_OPERADOR.ID_OPERADOR = OPERADOR.ID AND RESERVA.ID_ALOJAMIENTO = ALOJAMIENTO_OPERADOR.ID_ALOJA AND
RESERVA.fecha_llegada BETWEEN TO_DATE('01/01/2023','DD/MM/YYYY') AND TO_DATE('31/12/2023','DD/MM/YYYY')
AND RESERVA.fecha_salida  BETWEEN TO_DATE('01/01/2023','DD/MM/YYYY') AND TO_DATE('31/12/2023','DD/MM/YYYY')
GROUP BY operador.id, OPERADOR.NOMBRE
;
SELECT * 
FROM (SELECT operador.id, OPERADOR.NOMBRE AS OPERADOR,SUM(PRECIO) AS DINERO_RECIBIDO_CORRIDO
FROM RESERVA, OPERADOR, ALOJAMIENTO_OPERADOR
WHERE ALOJAMIENTO_OPERADOR.ID_OPERADOR = OPERADOR.ID AND RESERVA.ID_ALOJAMIENTO = ALOJAMIENTO_OPERADOR.ID_ALOJA
GROUP BY operador.id, OPERADOR.NOMBRE) NATURAL JOIN 
(SELECT operador.id, OPERADOR.NOMBRE AS OPERADOR,SUM(PRECIO) AS DINERO_RECIBIDO_ANIO_ACTUAL
FROM RESERVA, OPERADOR, ALOJAMIENTO_OPERADOR
WHERE ALOJAMIENTO_OPERADOR.ID_OPERADOR = OPERADOR.ID AND RESERVA.ID_ALOJAMIENTO = ALOJAMIENTO_OPERADOR.ID_ALOJA AND
RESERVA.fecha_llegada BETWEEN TO_DATE('01/01/2023','DD/MM/YYYY') AND TO_DATE('31/12/2023','DD/MM/YYYY')
AND RESERVA.fecha_salida  BETWEEN TO_DATE('01/01/2023','DD/MM/YYYY') AND TO_DATE('31/12/2023','DD/MM/YYYY')
GROUP BY operador.id, OPERADOR.NOMBRE)
;

--RFC2--
SELECT *
FROM (SELECT ALOJAMIENTO.ID, ALOJAMIENTO.TIPO_ALOJA, OPERADOR.NOMBRE AS OPERADOR,COUNT(*) AS CANT_RESERVAS
        FROM RESERVA, ALOJAMIENTO, OPERADOR, ALOJAMIENTO_OPERADOR
        WHERE RESERVA.ID_ALOJAMIENTO = ALOJAMIENTO.ID
            AND ALOJAMIENTO.ID = ALOJAMIENTO_OPERADOR.ID_ALOJA
            AND OPERADOR.ID = ALOJAMIENTO_OPERADOR.ID_OPERADOR
        GROUP BY ALOJAMIENTO.ID, ALOJAMIENTO.TIPO_ALOJA, OPERADOR.NOMBRE
        ORDER BY COUNT(*) DESC)
WHERE ROWNUM <= 20
;

--RFC3--
SELECT id, habitaciones_disponibles / num_habitaciones as indice_ocupacion
FROM hotel_hostal
UNION
SELECT id, numDisponible/numViviendas as indice_ocupacion
FROM edificio_universitario;

--RFC4--
SELECT a.id, a.capacidad, a.estado, a.direccion, a.tipo_aloja
FROM (SELECT a.id, a.capacidad, a.estado, a.direccion, a.tipo_aloja 
    FROM ALOJAMIENTO A LEFT JOIN RESERVA R
    ON a.ID = R.ID_ALOJAMIENTO
    WHERE R.fecha_llegada NOT BETWEEN TO_DATE('01/01/2023','DD/MM/YYYY') AND TO_DATE('02/09/2022','DD/MM/YYYY')
    AND R.fecha_salida NOT BETWEEN TO_DATE('01/01/2023','DD/MM/YYYY') AND TO_DATE('02/02/2022','DD/MM/YYYY') 
    OR R.fecha_salida IS NULL OR R.ESTADO = 'CANCELADA' ) A, ALOJAMIENTO_SERVICIO ASER, SERVICIO S
WHERE A.ID = ASER.ID_aLOJA AND ASER.ID_SERVICIO = S.ID
AND S.NOMBRE IN ('WI-FI','TINA')
GROUP BY a.id, a.capacidad, a.estado, a.direccion, a.tipo_aloja
HAVING COUNT(*) = 2
;

--RFC5:

SELECT VINCULO, COUNT(*) AS CANTIDAD_DE_USUARIOS
FROM (
    SELECT VINCULO FROM PERSONA
    UNION ALL
    SELECT VINCULO FROM CLIENTE
) 
GROUP BY VINCULO;

--RFC6:

SELECT 
    c.identificacion,
    TRUNC(MONTHS_BETWEEN(r.fecha_salida, r.fecha_llegada) * 30) AS noches_contratados,
    a.tipo_aloja,
    SUM(r.precio) AS dinero_pagado
FROM 
    cliente c 
    INNER JOIN reserva r ON c.identificacion = r.id_cliente 
    INNER JOIN alojamiento a ON r.id_alojamiento = a.id
WHERE 
    c.identificacion = 1
GROUP BY 
    c.identificacion, a.tipo_aloja, TRUNC(MONTHS_BETWEEN(r.fecha_salida, r.fecha_llegada) * 30);

--RFC7: 

SELECT TO_CHAR(FECHA_LLEGADA, 'MM/YYYY') AS MES,
       COUNT(ID_ALOJAMIENTO) AS ALOJAMIENTOS_OCUPADOS,
       SUM(PRECIO) AS INGRESOS,
       SUM(CAPACIDAD) AS OCUPACION
FROM RESERVA JOIN ALOJAMIENTO ON RESERVA.ID_ALOJAMIENTO = ALOJAMIENTO.ID 
WHERE FECHA_LLEGADA BETWEEN TO_DATE('01/01/2023','DD/MM/YYYY') AND TO_DATE('02/09/2023','DD/MM/YYYY')
AND ALOJAMIENTO.TIPO_ALOJA = 'VIVIENDA_U'
GROUP BY TO_CHAR(FECHA_LLEGADA, 'MM/YYYY')
ORDER BY MES, ALOJAMIENTOS_OCUPADOS,INGRESOS DESC, OCUPACION DESC ;

--RFC8:

SELECT C.IDENTIFICACION, COUNT(*) AS NUM_RESERVAS, SUM(TRUNC(MONTHS_BETWEEN(R.FECHA_SALIDA, R.FECHA_LLEGADA)*30)) AS NUM_NOCHES
FROM RESERVA R
INNER JOIN CLIENTE C ON R.ID_CLIENTE = C.IDENTIFICACION
WHERE R.ID_ALOJAMIENTO = 7
GROUP BY C.IDENTIFICACION
HAVING COUNT(*) >= 3 OR SUM(TRUNC(MONTHS_BETWEEN(R.FECHA_SALIDA, R.FECHA_LLEGADA)*30)) >= 15
ORDER BY NUM_RESERVAS DESC;

--RFC 9:

SELECT A.ID, A.TIPO_ALOJA
FROM ALOJAMIENTO A
WHERE NOT EXISTS (
    SELECT *
    FROM RESERVA R 
    WHERE R.ID_ALOJAMIENTO = A.ID
    AND R.FECHA_LLEGADA >= (SELECT MAX(FECHA_LLEGADA) FROM RESERVA WHERE ID_ALOJAMIENTO = A.ID) - INTERVAL '1' MONTH);
    
--RFC 10:

SELECT CLIENTE.*
FROM CLIENTE, RESERVA
WHERE CLIENTE.IDENTIFICACION = RESERVA.ID_CLIENTE
    AND RESERVA.FECHA_LLEGADA >= TO_DATE('01/05/2023','DD/MM/YYYY') 
    AND RESERVA.FECHA_SALIDA <= TO_DATE('01/12/2023','DD/MM/YYYY')
    AND RESERVA.ID_ALOJAMIENTO = 1890
GROUP BY CLIENTE.IDENTIFICACION, CLIENTE.NOMBRE, CLIENTE.VINCULO
;
--
SELECT C.*
FROM CLIENTE C, RESERVA R, ALOJAMIENTO A
WHERE C.IDENTIFICACION = R.ID_CLIENTE AND A.ID = R.ID_ALOJAMIENTO
    AND R.FECHA_LLEGADA >= TO_DATE('01/05/2016','DD/MM/YYYY') 
    AND R.FECHA_SALIDA <= TO_DATE('01/12/2023','DD/MM/YYYY')
    AND A.TIPO_ALOJA = 'HABITACION_HOTEL'
GROUP BY C.IDENTIFICACION, C.NOMBRE, C.VINCULO
;

--RFC 11:
SELECT C.IDENTIFICACION, C.NOMBRE, C.VINCULO
FROM CLIENTE C
WHERE C.IDENTIFICACION NOT IN (
  SELECT R.ID_CLIENTE
  FROM RESERVA R, ALOJAMIENTO A
  WHERE R.ID_ALOJAMIENTO = A.ID 
  AND A.TIPO_ALOJA = 'VIVIENDA_U'
  AND R.FECHA_LLEGADA >= TO_DATE('01/05/2023','DD/MM/YYYY') 
  AND R.FECHA_SALIDA <= TO_DATE('01/12/2023','DD/MM/YYYY')
)
ORDER BY C.IDENTIFICACION, C.VINCULO;

--RFC 12:    
SELECT
    O1.SEMANA,
    O1.ID_ALOJAMIENTO AS OFERTA_MAYOR_OCUPACION,
    O2.ID_ALOJAMIENTO AS OFERTA_MENOR_OCUPACION,
    OP1.NOMBRE AS OPERADOR_MAS_SOLICITADO,
    OP2.NOMBRE AS OPERADOR_MENOS_SOLICITADO
FROM
    (
        SELECT SEMANA, MAX(NUM_RESERVAS) AS MAX_OCUPACION
        FROM
            (
                SELECT
                    ID_ALOJAMIENTO,
                    TO_CHAR(FECHA_LLEGADA, 'IYYY-IW') AS SEMANA,
                    COUNT(*) AS NUM_RESERVAS
                FROM
                    RESERVA
                WHERE
                    ESTADO = 'ACTIVA'
                GROUP BY
                    ID_ALOJAMIENTO,
                    TO_CHAR(FECHA_LLEGADA, 'IYYY-IW')
            ) ocupacion_semanal
        GROUP BY SEMANA
    ) MAX_OCUPACION_SEMANAL
INNER JOIN
    (
        SELECT
            ID_ALOJAMIENTO,
            TO_CHAR(FECHA_LLEGADA, 'IYYY-IW') AS SEMANA,
            COUNT(*) AS NUM_RESERVAS
        FROM
            RESERVA
        WHERE
            ESTADO = 'ACTIVA'
        GROUP BY
            ID_ALOJAMIENTO,
            TO_CHAR(FECHA_LLEGADA, 'IYYY-IW')
    ) O1
    ON MAX_OCUPACION_SEMANAL.SEMANA = O1.SEMANA
    AND MAX_OCUPACION_SEMANAL.MAX_OCUPACION = O1.NUM_RESERVAS
INNER JOIN
    (
        SELECT SEMANA, MIN(NUM_RESERVAS) AS MIN_OCUPACION
        FROM
            (
                SELECT
                    ID_ALOJAMIENTO,
                    TO_CHAR(FECHA_LLEGADA, 'IYYY-IW') AS SEMANA,
                    COUNT(*) AS NUM_RESERVAS
                FROM
                    RESERVA
                WHERE
                    ESTADO = 'ACTIVA'
                GROUP BY
                    ID_ALOJAMIENTO,
                    TO_CHAR(FECHA_LLEGADA, 'IYYY-IW')
            ) ocupacion_semanal
        GROUP BY SEMANA
    ) MIN_OCUPACION_SEMANAL
    ON O1.SEMANA = MIN_OCUPACION_SEMANAL.SEMANA
INNER JOIN
    (
        SELECT
            ID_ALOJAMIENTO,
            TO_CHAR(FECHA_LLEGADA, 'IYYY-IW') AS SEMANA,
            COUNT(*) AS NUM_RESERVAS
        FROM
            RESERVA
        WHERE
            ESTADO = 'ACTIVA'
        GROUP BY
            ID_ALOJAMIENTO,
            TO_CHAR(FECHA_LLEGADA, 'IYYY-IW')
    ) O2
    ON MIN_OCUPACION_SEMANAL.SEMANA = O2.SEMANA
    AND MIN_OCUPACION_SEMANAL.MIN_OCUPACION = O2.NUM_RESERVAS
INNER JOIN
    (
        SELECT
            AO.ID_OPERADOR,
            COUNT(*) AS NUM_SOLICITUDES
        FROM
            ALOJAMIENTO_OPERADOR AO
            INNER JOIN RESERVA R ON AO.ID_ALOJA = R.ID_ALOJAMIENTO
        WHERE
            R.ESTADO = 'ACTIVA'
        GROUP BY
            AO.ID_OPERADOR
    ) SO1
    ON O1.ID_ALOJAMIENTO = SO1.ID_OPERADOR
INNER JOIN
    (
        SELECT
            AO.ID_OPERADOR,
            COUNT(*) AS NUM_SOLICITUDES
        FROM
            ALOJAMIENTO_OPERADOR AO
            INNER JOIN RESERVA R ON AO.ID_ALOJA = R.ID_ALOJAMIENTO
        WHERE
            R.ESTADO = 'ACTIVA'
        GROUP BY
            AO.ID_OPERADOR
    ) SO2
    ON O2.ID_ALOJAMIENTO = SO2.ID_OPERADOR
INNER JOIN OPERADOR OP1 ON SO1.ID_OPERADOR = OP1.ID
INNER JOIN OPERADOR OP2 ON SO2.ID_OPERADOR = OP2.ID;



--RFC 13:

SELECT DISTINCT C.IDENTIFICACION, C.NOMBRE, C.VINCULO,
       CASE WHEN MONTLY_RESERVAS.ID_CLIENTE IS NOT NULL THEN 'Realiza reservas mensuales' ELSE NULL END AS Calificacion_Reservas_Mensuales,
       CASE WHEN COSTOSO_RESERVAS.ID_CLIENTE IS NOT NULL THEN 'Reserva alojamientos costosos' ELSE NULL END AS Calificacion_Reservas_Costosas,
       CASE WHEN SUITE_RESERVAS.ID_CLIENTE IS NOT NULL THEN 'Reserva suites' ELSE NULL END AS Calificacion_Reservas_Suites
FROM CLIENTE C
LEFT JOIN (
    SELECT ID_CLIENTE
    FROM (
        SELECT ID_CLIENTE, EXTRACT(MONTH FROM FECHA_LLEGADA) AS MES, COUNT(*) AS NUM_RESERVAS
        FROM RESERVA
        GROUP BY ID_CLIENTE, EXTRACT(MONTH FROM FECHA_LLEGADA)
    ) RESERVAS_MENSUALES
    WHERE NUM_RESERVAS > 0
) MONTLY_RESERVAS ON C.IDENTIFICACION = MONTLY_RESERVAS.ID_CLIENTE
LEFT JOIN (
    SELECT ID_CLIENTE
    FROM (
        SELECT ID_CLIENTE, COUNT(*) AS NUM_RESERVAS_COSTOSAS
        FROM RESERVA
        WHERE PRECIO > 150
        GROUP BY ID_CLIENTE
    ) RESERVAS_COSTOSAS
) COSTOSO_RESERVAS ON C.IDENTIFICACION = COSTOSO_RESERVAS.ID_CLIENTE
LEFT JOIN (
    SELECT ID_CLIENTE
    FROM (
        SELECT ID_CLIENTE, COUNT(*) AS NUM_RESERVAS_SUITE
        FROM RESERVA R
        JOIN HAB_HOTEL HH ON R.ID_ALOJAMIENTO = HH.ID_ALOJA
        WHERE HH.CATEGORIA = 'SUIT'
        GROUP BY ID_CLIENTE
    ) RESERVAS_SUITE
) SUITE_RESERVAS ON C.IDENTIFICACION = SUITE_RESERVAS.ID_CLIENTE
WHERE MONTLY_RESERVAS.ID_CLIENTE IS NOT NULL 
    OR COSTOSO_RESERVAS.ID_CLIENTE IS NOT NULL
    OR SUITE_RESERVAS.ID_CLIENTE IS NOT NULL
;






